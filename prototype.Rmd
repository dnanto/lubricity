```{r setup, include=F}
library(tidyverse)
source("prototype.R")
knitr::opts_chunk$set(echo = F)
```

# country name  cn    "United States"  country
# iso           cc2   "US"             country code
# iso3          cc3   "USA"            country code
# admin code 1  ac1   "US.VA"          state
# admin code 1  ac1n  "Virginia"       state
# admin code 2  ac2n  "US.VA.059"      county
# admin code 2  ac2n  "Fairfax County" county

```{r}
countrify("US")
countrify("USA")
countrify("United States")
countrify("Vietnam")
countrify("Viet Nam")
codify.1("Virginia")
codify.2("Fairfax County")
codify.2("Fairfax Country")
```

```{r}
df.src <- read_tsv("data/sample/src.zip", col_types = cols(.default = "c"))
query <- sort(unique(df.src$country))
```

```{r}
process_regx <- function(val, regx, n = 1)
{
  tokens <- setNames(tail(str_match(val, regx$pattern)[1,], -1), regx$names)
  result <- list(cn = NA, ac1 = NA, ac2 = NA, ac3 = NA, ac4 = NA)
  
  if (!any(is.na(tokens)))
  {
    # process admin code hierarchy
    for (name in names(sort(code[regx$names])))
    {
      if (name == "cn") 
      {  
        result[[name]] <- countrify(tokens[[name]], n = n)
      }
      else if (name == "ac1")
      {
        result[[name]] <- codify.1(tokens[[name]], cc2 = result$cn, n = n)
      }
      else if (name == "ac2")
      {
        result[[name]] <- codify.2(tokens[[name]], cc2 = result$cn, ac1 = result$ac1, n = n)
      }
    }
  }
  
  result
}

process_regx_list <- function(val, regx_list)
{
  coalesce(!!!lapply(regx_list, process_regx, val = val))
}
```

```{r}
regx_list <- list(
  list(pattern = "(.+)", names = c("cn")),
  list(pattern = "(.+):\\s*(.+)", names = c("cn", "ac1")),
  # list(pattern = "(.+):\\s*(.+)", names = c("cn", "ac2")),
  list(pattern = "(.+):\\s*(.+),", names = c("cn", "ac1")),
  # list(pattern = "(.+):\\s*(.+),", names = c("cn", "ac2")),
  list(pattern = "(.+):\\s*.+,\\s*(.+)", names = c("cn", "ac1")),
  # list(pattern = "(.+):\\s*.+,\\s*(.+)", names = c("cn", "ac2")),
  list(pattern = "(.+):\\s*(.+)\\s*,\\s*(.+)", names = c("cn", "ac1", "ac2")),
  list(pattern = "(.+):\\s*(.+)\\s*,\\s*(.+)", names = c("cn", "ac2", "ac1"))
)

x <- distinct(df.src, country)

pull(x, country) %>% 
  lapply(process_regx_list, regx_list = regx_list) %>%
  bind_rows() %>%
  bind_cols(x, .) %>%
  arrange(country)
```

```{r}
process_regx_list(
  "USA: Pittsburgh, Pennsylvania", 
  regx_list = list(
    list(pattern = "(.+):\\s*.+,\\s*(.+)", names = c("cn", "ac1")),
    list(pattern = "(.+):\\s*(.+),", names = c("cn", "ac1")),
    list(pattern = "(.+):\\s*(.+),", names = c("cn", "ac2"))
  )
)
```
