```{r setup, include=F}
library(tidyverse)
knitr::opts_chunk$set(echo = F)
```

```{r}
col_names <- c(
  "geonameid", "name", "asciiname", "alternatenames",
  "latitude", "longitude",  "feature_class", "feature_code",
  "country_code", "cc2",
  "admin1_code", "admin2_code", "admin3_code", "admin4_code",
  "population", "elevation", "dem", "timezone",
  "modification_date"
)
df.city <- read_tsv("data/geonames/cities500.zip", col_names = col_names, col_types = "iccccccccccccciiccT")
```

```{r}
col_names <- c(
  "iso", "iso3",	"iso_num", "fips", "country", "capital", "area",
  "population",	"continent", "tld",	"currency_code",
  "currency_name", "phone", "postal_code_format", "postal_code_regex",
  "languages", "geonameid", "neighbours", "equivalent_fips_code"
)
df.country <-
  read_lines("data/geonames/countryInfo.txt") %>%
  enframe(name = NULL) %>%
  filter(!startsWith(value, "#")) %>%
  pull(value) %>%
  read_tsv(col_names = col_names)
```

```{r}
df.src <- read_tsv("data/sample/src.zip", col_types = cols(.default = "c")) %>% select(accver, country)
```

```{r}
country.letters <- paste(unique(strsplit(paste(df.country$country, collapse = ""), "")[[1]]), collapse = "")
country.regex <- str_replace(country.letters, "-", "\\\\-") %>% paste0("[^", ., "]")

country.sanitize <- function(value) str_squish(str_replace_all(value, country.regex, " "))

country.normalize <- function(query, n = 1, ...)
{
  i <- NA
  
  # exact
  if (any(idx <- which(toupper(query) == df.country$iso))) i <- idx
  else if (any(idx <- which(toupper(query) == df.country$iso3))) i <- idx
  else if (any(idx <- which(query == df.country$country))) i <- idx
  else
  {
    # fuzzy
    results <- agrep(query, df.country$country, ignore.case = T, ...)
    if (length(results <= n)) i <- results[[1]]
  }
  
  i
}

mutate(df.src, clean = sapply(country.sanitize(country), country.normalize))
``` 
